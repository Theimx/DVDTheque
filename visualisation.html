<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>DVDthÃ¨que</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <h1>ğŸ“‹ Ma DVDthÃ¨que</h1>
  <a class="nav-btn" href="ajout.html">â• Ajouter un DVD</a>
</header>

<!-- Ouverture du CSV -->
<div class="card">
  <button class="primary" onclick="ouvrirCSV()">ğŸ“‚ Ouvrir dvdtheque.csv</button>
</div>

<!-- Stats + Recherche -->
<div class="search-layout">

  <!-- Statistiques -->
  <div class="card stats">
    <h3>ğŸ“Š Statistiques</h3>
    <p>ğŸ¬ Total de films : <strong id="statTotal">0</strong></p> 
    <p>ğŸ’° Valeur totale : <strong id="statValeur">0 â‚¬</strong></p>
    <p>ğŸ† Palmes d'Or : <strong id="statPalme">0</strong></p>
    <p>ğŸ– Films rÃ©compensÃ©s : <strong id="statRecompense">0</strong></p>
  </div>

  <!-- Recherche -->
  <div class="card">
    <h3>ğŸ” Recherche</h3>

    <input id="searchRealisateur" placeholder="RÃ©alisateur">
    <input id="searchGenre" placeholder="Genre">
    <input id="searchPays" placeholder="Pays">
    <input id="searchPrix" type="number" placeholder="Prix maximum (â‚¬)">

    <label>RÃ©compense</label>
    <select id="searchRecompense">
      <option value="">Tous</option>
      <option value="Oui">Oui</option>
      <option value="Non">Non</option>
    </select>

    <button class="primary" onclick="render()">Appliquer la recherche</button>
  </div>

</div>

<!-- RÃ©sultats -->
<div id="grid" class="grid"></div>

<script>
let fileHandle;
let dvds = [];
const grid = document.getElementById("grid");

async function ouvrirCSV() {
  [fileHandle] = await window.showOpenFilePicker({
    types: [{ description: "DVDthÃ¨que", accept: { "text/csv": [".csv"] } }]
  });

  const file = await fileHandle.getFile();
  const text = await file.text();
  chargerCSV(text);
  render();
}

function chargerCSV(text) {
  const lines = text.split("\n").slice(1);
  dvds = lines.filter(l => l.trim()).map(l => {
    const v = l
      .split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
      .map(x => x.replace(/"/g, ""));
    return {
      titre: v[0],
      annee: v[1],
      genres: v[2],
      realisateurs: v[3],
      pays: v[4],
      acteurs: v[5],
      palme: v[6],
      recompense: v[7],
      duree: v[8],
      coffret: v[9],
      groupe: v[10],
      prix: v[11],
      support: v[12]
    };
  });
}

function updateStats(filteredDvds = dvds) {
  let total = 0;
  let palmes = 0;
  let recompenses = 0;

  filteredDvds.forEach(d => {
    total += parseFloat(d.prix || 0);
    if (d.palme === "Oui") palmes++;
    if (d.recompense === "Oui") recompenses++;
  });

  statValeur.textContent = total.toFixed(2) + " â‚¬";
  statPalme.textContent = palmes;
  statRecompense.textContent = recompenses+palmes;
  statTotal.textContent = filteredDvds.length; // Total de films filtrÃ©s
}

function render() {
  grid.innerHTML = "";

  const r = searchRealisateur.value.toLowerCase();
  const g = searchGenre.value.toLowerCase();
  const pa = searchPays.value.toLowerCase();
  const pr = parseFloat(searchPrix.value);
  const rec = searchRecompense.value;

  const filtered = dvds.filter(d => {
    return (
      (!r || d.realisateurs.toLowerCase().includes(r)) &&
      (!g || d.genres.toLowerCase().includes(g)) &&
      (!pa || d.pays.toLowerCase().includes(pa)) &&
      (!pr || parseFloat(d.prix || 0) <= pr) &&
      (!rec || d.recompense === rec)
    );
  });

  filtered.forEach((d, i) => {
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `
      <h2>${d.titre}</h2>
      <p><strong>${d.annee}</strong> â€¢ ${d.support}</p>
      <p>ğŸ ${d.genres}</p>
      <p>ğŸ¬ RÃ©alisateur(s) : ${d.realisateurs}</p>
      <p>ğŸ­ Acteurs : ${d.acteurs}</p>
      <p>ğŸŒ Pays : ${d.pays}</p>
      <p>â± ${d.duree} min</p>
      <p>ğŸ† Palme d'Or : ${d.palme}</p>
      <p>ğŸ– RÃ©compense : ${d.recompense}</p>
      <p>ğŸ Coffret : ${d.coffret} ${d.groupe ? "(" + d.groupe + ")" : ""}</p>
      <p>ğŸ’° ${d.prix} â‚¬</p>

      <button class="danger" onclick="supprimer(${i})">âŒ Supprimer</button>
    `;
    grid.appendChild(c);
  });

  updateStats(filtered); // Met Ã  jour stats selon la recherche
}

async function sauvegarderCSV() {
  const writable = await fileHandle.createWritable();
  let csv =
    "Titre,AnnÃ©e,Genres,Realisateurs,Pays,Acteurs,PalmeOr,AutreRecompense,Duree,Coffret,GroupeCoffret,Prix,Support\n";

  dvds.forEach(d => {
    csv += Object.values(d).map(v => `"${v || ""}"`).join(",") + "\n";
  });

  await writable.write(csv);
  await writable.close();
}

async function supprimer(i) {
  if (confirm("Supprimer ce DVD ?")) {
    dvds.splice(i, 1);
    await sauvegarderCSV();
    render();
  }
}
</script>

</body>
</html>